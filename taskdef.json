{
    "family": "login-app",
    "containerDefinitions": [
        {
            "name": "cws-instrumentation-init",
            "image": "datadog/cws-instrumentation:latest",
            "cpu": 0,
            "portMappings": [],
            "essential": false,
            "command": [
                "/cws-instrumentation",
                "setup",
                "--cws-volume-mount",
                "/cws-instrumentation-volume"
            ],
            "environment": [],
            "mountPoints": [
                {
                    "sourceVolume": "cws-instrumentation-volume",
                    "containerPath": "/cws-instrumentation-volume",
                    "readOnly": false
                }
            ],
            "volumesFrom": [],
            "user": "0",
            "systemControls": []
        },
        {
            "name": "datadog-agent",
            "image": "public.ecr.aws/datadog/agent:latest",
            "cpu": 0,
            "portMappings": [
                {
                    "containerPort": 8126,
                    "hostPort": 8126,
                    "protocol": "tcp"
                }
            ],
            "essential": true,
            "environment": [
                { "name": "DD_API_KEY", "value": "24d4fd9b038e72e2beaaec1cdf2ab844" },
                { "name": "DD_SITE", "value": "datadoghq.com" },
                { "name": "ECS_FARGATE", "value": "true" },
                { "name": "DD_APM_ENABLED", "value": "true" },
                { "name": "DD_LOGS_ENABLED", "value": "true" },
                { "name": "DD_PROCESS_AGENT_ENABLED", "value": "true" },
                { "name": "DD_TAGS", "value": "env:production,team:dev,task_family:${ECS_TASK_FAMILY}" },
                { "name": "DD_APM_NON_LOCAL_TRAFFIC", "value": "true" },
                { "name": "DD_RUNTIME_SECURITY_CONFIG_ENABLED", "value": "true" },
                { "name": "DD_RUNTIME_SECURITY_CONFIG_EBPFLESS_ENABLED", "value": "true" },
                { "name": "DD_PROCESS_CONFIG_PROCESS_COLLECTION_ENABLED", "value": "true" },
                { "name": "DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL", "value": "true" },
                { "name": "ECS_CONTAINER_METADATA_URI_V4", "value": "http://169.254.170.2/v4/" },
                { "name": "DD_TRACE_AGENT_PORT", "value": "8126" }
            ],
            "mountPoints": [],
            "volumesFrom": [],
            "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                    "awslogs-group": "/ecs/datadog-agent",
                    "awslogs-region": "us-east-1",
                    "awslogs-stream-prefix": "datadog"
                }
            },
            "healthCheck": {
                "command": [
                    "CMD-SHELL",
                    "/probe.sh"
                ],
                "interval": 30,
                "timeout": 5,
                "retries": 2,
                "startPeriod": 60
            },
            "systemControls": []
        },
        {
            "name": "loginapp",
            "image": "${ECR_REPOSITORY_URI}:latest",
            "cpu": 0,
            "portMappings": [
                {
                    "containerPort": 80,
                    "hostPort": 80,
                    "protocol": "tcp"
                }
            ],
            "essential": true,
            "entryPoint": [
                "dotnet",
                "LoginApp.dll"
            ],
            "environment": [
                { "name": "DD_AGENT_HOST", "value": "datadog-agent" },
                { "name": "DD_SERVICE", "value": "loginapp" },
                { "name": "DD_ENV", "value": "production" },
                { "name": "DD_VERSION", "value": "1.0.0" },
                { "name": "DD_LOG_LEVEL", "value": "debug" },
                { "name": "DD_APM_INSTRUMENTATION_ENABLED", "value": "true" },
                { "name": "DD_TRACE_ENABLED", "value": "true" },
                { "name": "DD_TRACE_DEBUG", "value": "true" },
                { "name": "DD_TRACE_AGENT_PORT", "value": "8126" },
                { "name": "CORECLR_ENABLE_PROFILING", "value": "1" },
                { "name": "CORECLR_PROFILER", "value": "{846F5F1C-F9AE-4B07-969E-05C26BC060D8}" },
                { "name": "CORECLR_PROFILER_PATH", "value": "/opt/datadog/Datadog.Trace.ClrProfiler.Native.so" }
            ],
            "mountPoints": [
                {
                    "sourceVolume": "cws-instrumentation-volume",
                    "containerPath": "/cws-instrumentation-volume",
                    "readOnly": true
                }
            ],
            "volumesFrom": [],
            "linuxParameters": {
                "capabilities": {
                    "add": [
                        "SYS_PTRACE"
                    ],
                    "drop": []
                }
            },
            "dependsOn": [
                {
                    "containerName": "datadog-agent",
                    "condition": "HEALTHY"
                },
                {
                    "containerName": "cws-instrumentation-init",
                    "condition": "SUCCESS"
                }
            ],
            "logConfiguration": {
                "logDriver": "awsfirelens",
                "options": {
                    "dd_service": "loginapp",
                    "Host": "http-intake.logs.datadoghq.com",
                    "TLS": "on",
                    "dd_source": "aspnetcore",
                    "apikey": "24d4fd9b038e72e2beaaec1cdf2ab844",
                    "Name": "datadog"
                }
            },
            "systemControls": []
        },
        {
            "name": "log-router",
            "image": "amazon/aws-for-fluent-bit:latest",
            "cpu": 0,
            "portMappings": [],
            "essential": true,
            "environment": [],
            "mountPoints": [],
            "volumesFrom": [],
            "user": "0",
            "logConfiguration": {
                "logDriver": "awslogs",
                "options": {
                    "awslogs-group": "/ecs/login-router",
                    "awslogs-region": "us-east-1",
                    "awslogs-stream-prefix": "logrouter"
                }
            },
            "systemControls": [],
            "firelensConfiguration": {
                "type": "fluentbit"
            }
        }
    ],
    "taskRoleArn": "${ECS_TASK_ROLE_ARN}",
    "executionRoleArn": "${ECS_EXECUTION_ROLE_ARN}",
    "networkMode": "awsvpc",
    "volumes": [
        {
            "name": "cws-instrumentation-volume",
            "host": {}
        }
    ],
    "placementConstraints": [],
    "requiresCompatibilities": [
        "FARGATE"
    ],
    "cpu": "1024",
    "memory": "3072",
    "pidMode": "task"
}
